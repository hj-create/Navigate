/* Hardened rewards engine: stable tiers, duplicate-init guard, cross-tab sync */(() => {  if (window.__NAVIGATE_REWARDS_INIT__) return;  window.__NAVIGATE_REWARDS_INIT__ = true;  const VERSION = '2.3.0';  const STORAGE_KEY = 'navigate_rewards_full_v1';  const UPDATE_EVENT = 'rewards:update';  const tiers = [    { id: 0, name: 'Newcomer', points: 0 },    { id: 1, name: 'Explorer', points: 100 },    { id: 2, name: 'Apprentice Historian', points: 250 },    { id: 3, name: 'Scholar', points: 500 },    { id: 4, name: 'Strategist', points: 750 },    { id: 5, name: 'Master Historian', points: 1000 },    { id: 6, name: 'Historian of Distinction', points: 1500 },    { id: 7, name: 'Grand Historian', points: 2000 },  ];  const storeItems = [    { id: 'hist_hat', type: 'customization', name: 'Historian Hat (Avatar)', cost: 150 },    { id: 'badge_mesopotamia', type: 'badge', name: 'Mesopotamia Master', cost: 200 },    { id: 'badge_roman_explorer', type: 'badge', name: 'Roman Empire Explorer', cost: 500 },    { id: 'video_ag_rev', type: 'content', name: 'Bonus Video: Agricultural Revolution', cost: 250, url: 'https://www.youtube.com/watch?v=Yocja_N5s1I' },    { id: 'game_ancient_mystery', type: 'game', name: 'Ancient History Mystery Game', cost: 300, url: 'https://www.purposegames.com/game/ms-ladues-early-civilizations-quiz?l=21519' },  ];  const initialState = {    points: 0,    lastLoginDate: null,    lastActivityDate: null,    streakDays: 0,    weeklyProgress: 0,    lastWeeklyBonusDate: null,    consecutiveLessonCount: 0,    subjectPoints: { us: 0, world: 0, european: 0 },    activities: {      lessonsCompleted: 0,      quizzesCompleted: 0,      quizzesPassed70: 0,      quizzesAbove80: 0,      videosWatched: 0,      videosWatchedNoSkip: 0,      challengesCompleted: 0,    },    recentActivity: [],    unlockedAchievements: [],    unlockedItems: []  };  const achDefs = [    { id: 'ach_history_starter', name: 'History Starter Certificate (100 pts)', rule: s => s.points >= 100 },    { id: 'ach_lesson_explorer', name: 'Lesson Explorer (5 lessons/videos)', rule: s => (s.activities.lessonsCompleted + s.activities.videosWatched) >= 5 },    { id: 'ach_quiz_conqueror', name: 'Quiz Conqueror (3× ≥70%)', rule: s => s.activities.quizzesPassed70 >= 3 },    { id: 'ach_rising_historian', name: 'Rising Historian (250 pts)', rule: s => s.points >= 250 },    { id: 'ach_us_foundations', name: 'US History Foundations (500 US pts)', rule: s => s.subjectPoints.us >= 500 },    { id: 'ach_world_foundations', name: 'World History Foundations', rule: s => s.subjectPoints.world >= 400 },    { id: 'ach_eu_foundations', name: 'European History Foundations', rule: s => s.subjectPoints.european >= 400 },    { id: 'ach_critical_thinker', name: 'Critical Thinker (5× ≥80%)', rule: s => s.activities.quizzesAbove80 >= 5 },    { id: 'ach_consistency_champion', name: 'Consistency Champion (7‑day streak)', rule: s => s.streakDays >= 7 },    { id: 'ach_certified_historian', name: 'Certified Historian (1500 pts)', rule: s => s.points >= 1500 },    { id: 'ach_history_honors', name: 'History Honors', rule: s => (s.activities.lessonsCompleted >= 10 && s.activities.quizzesAbove80 >= 5) },    { id: 'ach_academic_excellence', name: 'Academic Excellence in History', rule: s => (s.points >= 1800 && s.activities.quizzesAbove80 >= 8) },  ];  const load = () => {    try {      const raw = localStorage.getItem(STORAGE_KEY);      return raw ? { ...initialState, ...JSON.parse(raw) } : { ...initialState };    } catch { return { ...initialState }; }  };  const save = (s) => {    try {      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));      window.dispatchEvent(new CustomEvent(UPDATE_EVENT));    } catch {}  };  const todayStr = () => new Date().toISOString().slice(0, 10);  const addActivity = (s, label, pts) => {    s.recentActivity.unshift({ when: new Date().toLocaleString(), label, pts });    s.recentActivity = s.recentActivity.slice(0, 12);  };  const addPoints = (s, n, label) => { s.points += n; if (label) addActivity(s, label, n); };  const markLogin = (s) => { s.lastLoginDate = todayStr(); };  const markActivityDay = (s) => {    const t = todayStr();    if (s.lastActivityDate !== t) {      const prev = s.lastActivityDate ? new Date(s.lastActivityDate) : null;      const now = new Date(t);      const diff = prev ? Math.round((now - prev) / 86400000) : 0;      s.streakDays = prev ? (diff === 1 ? s.streakDays + 1 : 1) : 1;      s.lastActivityDate = t;      if (s.lastLoginDate === t) {        s.weeklyProgress = Math.min(7, s.weeklyProgress + 1);        if (s.weeklyProgress === 7 && s.lastWeeklyBonusDate !== t) {          s.lastWeeklyBonusDate = t;          addPoints(s, 50, 'Weekly streak bonus');        }      }    }  };  const currentTier = (points) => { let t = tiers[0]; for (const tier of tiers) if (points >= tier.points) t = tier; return t; };  const nextTier = (points) => tiers.find(t => points < t.points) || null;  const Rewards = {    __v: VERSION,    state: load(),    dailyLogin() {      const s = this.state, t = todayStr();      if (s.lastLoginDate === t) return false;      addPoints(s, 5, 'Daily login');      markLogin(s);      save(s); RewardsUI.render(); return true;    },    completeLesson(subject) {      const s = this.state;      s.activities.lessonsCompleted += 1;      s.consecutiveLessonCount += 1;      addPoints(s, 50, 'Lesson completed');      if (s.consecutiveLessonCount > 1) addPoints(s, 10, 'Consecutive lesson bonus');      if (subject && s.subjectPoints[subject] != null) s.subjectPoints[subject] += 50;      markActivityDay(s); maybeUnlock(s); save(s); RewardsUI.render();    },    completeQuiz(score, subject) {      const s = this.state;      s.activities.quizzesCompleted += 1;      addPoints(s, 30, 'Quiz completed');      if (score >= 70) s.activities.quizzesPassed70 += 1;      if (score >= 80) { s.activities.quizzesAbove80 += 1; addPoints(s, 10, 'Quiz ≥80% bonus'); }      s.consecutiveLessonCount = 0;      if (subject && s.subjectPoints[subject] != null) s.subjectPoints[subject] += (score >= 80 ? 40 : 30);      markActivityDay(s); maybeUnlock(s); save(s); RewardsUI.render();    },    watchVideo(noSkip, subject) {      const s = this.state;      s.activities.videosWatched += 1;      addPoints(s, 20, 'Video watched');      if (noSkip) { s.activities.videosWatchedNoSkip += 1; addPoints(s, 5, 'No‑skip bonus'); }      s.consecutiveLessonCount = 0;      if (subject && s.subjectPoints[subject] != null) s.subjectPoints[subject] += (noSkip ? 25 : 20);      markActivityDay(s); maybeUnlock(s); save(s); RewardsUI.render();    },    redeemItem(id) {      const s = this.state; const item = storeItems.find(i => i.id === id);      if (!item || s.unlockedItems.includes(id) || s.points < item.cost) return false;      s.points -= item.cost; s.unlockedItems.push(id); addActivity(s, `Redeemed: ${item.name}`, -item.cost);      maybeUnlock(s); save(s); RewardsUI.render(); return true;    },    getTierInfo() {      const s = this.state; const cur = currentTier(s.points); const nxt = nextTier(s.points);      const span = nxt ? (nxt.points - cur.points) : 1;      const progress = nxt ? Math.round((s.points - cur.points) / span * 100) : 100;      return { current: cur, next: nxt, progress: Math.min(100, Math.max(0, progress)) };    },    _debugReset() { this.state = { ...initialState }; save(this.state); RewardsUI.render(); },    // Sync points from profile progress percent (0–100).    // mode 'set' sets points exactly; mode 'max' uses the higher of current vs progress-derived.    syncPointsFromProfileProgress(progressPercent, mode = 'max') {      const s = this.state;      const pct = Math.max(0, Math.min(100, Number(progressPercent || 0)));      const progressPoints = Math.round(pct); // 1 point per 1% progress      const nextPoints = mode === 'set' ? progressPoints : Math.max(s.points, progressPoints);      if (nextPoints !== s.points) {        s.points = nextPoints;        // optional activity log entry        s.recentActivity.unshift({          when: new Date().toLocaleString(),          label: `Profile progress sync (${pct}%)`,          pts: nextPoints - (s.points || 0)        });        s.recentActivity = s.recentActivity.slice(0, 12);        // Save and update UI        try { localStorage.setItem('navigate_rewards_full_v1', JSON.stringify(s)); } catch {}        window.dispatchEvent(new CustomEvent('rewards:update'));      }    },  };  // Listen for login and apply profile progress once  document.addEventListener('DOMContentLoaded', () => {    window.addEventListener('auth:login', (e) => {      // Only update when logged-in      if (!window.NavigateAuth || !window.NavigateAuth.isLoggedIn()) return;      const detail = e?.detail || {};      const pct = Number(detail.profileProgress ?? detail.progress ?? 0);      window.NavigateRewards.syncPointsFromProfileProgress(pct, 'max');    });  });  const maybeUnlock = (s) => {    for (const a of achDefs) if (a.rule(s) && !s.unlockedAchievements.includes(a.id)) {      s.unlockedAchievements.push(a.id);      addActivity(s, `Achievement: ${a.name}`, 0);    }  };  const RewardsUI = {    els: null,    init() {      const panel = document.getElementById('rewardsPanel');      if (!panel) return;      this.els = {        panel,        points: panel.querySelector('[data-points]'),        progressBar: panel.querySelector('.rewards-progress-bar'),        progressText: panel.querySelector('[data-progress-text]'),        streakDays: panel.querySelector('[data-streak-days]'),        weeklyProgress: panel.querySelector('[data-weekly-progress]'),        achList: panel.querySelector('[data-achievements]'),        storeList: panel.querySelector('[data-store]'),        activityLog: panel.querySelector('[data-activity-log]')      };      panel.querySelector('#claimDaily')?.addEventListener('click', () => Rewards.dailyLogin());      this.render();    },    render() {      if (!this.els) return;      const s = Rewards.state;      const info = Rewards.getTierInfo();      this.els.points.textContent = s.points;      this.els.progressBar.style.width = `${info.progress}%`;      this.els.progressText.textContent = info.next        ? `${s.points}/${info.next.points} → ${info.next.name}`        : `${s.points} (Max tier reached)`;      this.els.streakDays.textContent = s.streakDays || 0;      this.els.weeklyProgress.textContent = `${s.weeklyProgress}/7`;      this.els.achList.innerHTML = [        ...achDefs.map(a => `          <li class="${s.unlockedAchievements.includes(a.id) ? 'unlocked' : ''}">            <span class="material-icons" aria-hidden="true">${s.unlockedAchievements.includes(a.id) ? 'emoji_events' : 'lock'}</span>            ${a.name}          </li>        `)      ].join('');      this.els.storeList.innerHTML = storeItems.map(item => {        const owned = s.unlockedItems.includes(item.id);        const afford = s.points >= item.cost;        const icon = item.type === 'badge' ? 'military_tech' : item.type === 'game' ? 'sports_esports' : item.type === 'content' ? 'ondemand_video' : 'style';
        return `
          <li class="store-item ${owned ? 'owned' : ''}">
            <div class="store-name"><span class="material-icons">${icon}</span>${item.name}</div>
            <div class="store-meta">
              <span class="cost">${item.cost} pts</span>
              ${owned ? '<span class="owned-label">Owned</span>' : `<button class="primary-btn" ${afford ? '' : 'disabled'} data-redeem="${item.id}">Redeem</button>`}
              ${item.url ? `<a href="${item.url}" target="_blank" rel="noopener">View</a>` : ''}
            </div>
          </li>
        `;
      }).join('');
      this.els.storeList.querySelectorAll('[data-redeem]').forEach(btn => {
        btn.addEventListener('click', () => Rewards.redeemItem(btn.getAttribute('data-redeem')));
      });

      this.els.activityLog.innerHTML = s.recentActivity.length
        ? s.recentActivity.map(e => `<li><span class="material-icons" aria-hidden="true">check_circle</span><strong>${e.label}</strong> • ${e.pts > 0 ? '+' : ''}${e.pts} pts • <span style="color:#666">${e.when}</span></li>`).join('')
        : `<li><span class="material-icons" aria-hidden="true">info</span>No recent activity yet.</li>`;
    }
  };

  document.addEventListener('DOMContentLoaded', () => RewardsUI.init());
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') { Rewards.state = load(); RewardsUI.render(); }
  });
  window.addEventListener('storage', (e) => {
    if (e.key === STORAGE_KEY) { Rewards.state = load(); RewardsUI.render(); }
  });
  window.addEventListener(UPDATE_EVENT, () => RewardsUI.render());

  window.NavigateRewards = window.NavigateRewards || Rewards;
  if (!window.NavigateRewards.__v) window.NavigateRewards.__v = VERSION;
})();